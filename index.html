<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Notebooks - Leil√£o</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 130px;
            padding: 20px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: #f5f5f5;
            font-size: 17px;
            font-weight: 600;
            line-height: 1.5;
        }

        .tab:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .tab.active {
            background: white;
            border-bottom: 4px solid #667eea;
            color: #667eea;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .card .value {
            font-size: 1.8em;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .resultado {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .resultado h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .resultado-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }

        .resultado-item:last-child {
            border-bottom: none;
        }

        .resultado-destaque {
            font-weight: bold;
            font-size: 1.2em;
            color: #667eea;
        }

        .btn-action {
            padding: 6px 12px;
            margin: 0 3px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            color: white;
        }

        .btn-edit {
            background: #3498db;
        }

        .btn-edit:hover {
            background: #2980b9;
        }

        .btn-delete {
            background: #e74c3c;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pendente {
            background: #ffeaa7;
            color: #d63031;
        }

        .status-parcial {
            background: #74b9ff;
            color: #0984e3;
        }

        .status-vendido {
            background: #55efc4;
            color: #00b894;
        }

        .alerta {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 12px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 14px;
            color: #2c3e50;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: width 0.3s;
        }

        .sugestao-preco {
            background: #d4edda;
            border: 2px solid #28a745;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }

        .sugestao-preco .preco {
            font-size: 2em;
            font-weight: bold;
            color: #28a745;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üíª Gest√£o de Notebooks - Leil√£o</h1>
            <p>Controle completo de compra, venda e lucro por unidade</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="openTab(event, 'dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="openTab(event, 'compra')">‚ûï Nova Compra</button>
            <button class="tab" onclick="openTab(event, 'despesas')">üí∞ Despesas</button>
            <button class="tab" onclick="openTab(event, 'calculo')">üßÆ Calcular Venda</button>
            <button class="tab" onclick="openTab(event, 'vendas')">‚úÖ Registrar Venda</button>
            <button class="tab" onclick="openTab(event, 'lotes')">üìã Meus Lotes</button>
            <button class="tab" onclick="openTab(event, 'historico')">üìú Hist√≥rico</button>
        </div>

        <div class="content">
            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active">
                <div class="dashboard" id="dashboardCards"></div>
                <h2>Resumo dos Lotes</h2>
                <div id="dashboardTable"></div>
            </div>

            <!-- Nova Compra -->
            <div id="compra" class="tab-content">
                <h2>‚ûï Registrar Nova Compra</h2>
                <form onsubmit="adicionarCompra(event)">
                    <input type="hidden" id="editandoLoteId">
                    <div class="form-group">
                        <label>Nome/Identifica√ß√£o do Lote:</label>
                        <input type="text" id="nomeLote" required placeholder="Ex: Lote 01 - Dell Inspiron">
                    </div>

                    <div class="form-group">
                        <label>Quantidade de Notebooks:</label>
                        <input type="number" id="quantidade" required min="1" placeholder="Ex: 3">
                    </div>

                    <div class="form-group">
                        <label>Valor Total da Compra (R$):</label>
                        <input type="number" id="valorCompra" required step="0.01" min="0" placeholder="Ex: 800.00">
                    </div>

                    <div class="form-group">
                        <label>Observa√ß√µes:</label>
                        <textarea id="observacoes" rows="3" placeholder="Detalhes, estado dos notebooks, etc."></textarea>
                    </div>

                    <button type="submit" id="btnSalvarLote">üíæ Salvar Compra</button>
                    <button type="button" id="btnCancelarEdicaoLote" class="hidden" onclick="cancelarEdicaoLote()" style="background: #95a5a6;">‚ùå Cancelar</button>
                </form>
            </div>

            <!-- Despesas -->
            <div id="despesas" class="tab-content">
                <h2>üí∞ Gerenciar Despesas</h2>
                <div id="alertaDespesas"></div>
                <form onsubmit="adicionarDespesa(event)">
                    <input type="hidden" id="editandoDespesaId">
                    <div class="form-group">
                        <label>Selecione o Lote:</label>
                        <select id="loteDespesa" required></select>
                    </div>

                    <div class="form-group">
                        <label>Tipo de Despesa:</label>
                        <select id="tipoDespesa" required onchange="mostrarCamposComissao()">
                            <option value="">Selecione...</option>
                            <option value="Manuten√ß√£o">Manuten√ß√£o/Reparo</option>
                            <option value="Comiss√£o ML">Comiss√£o Mercado Livre</option>
                            <option value="Frete">Frete</option>
                            <option value="Embalagem">Embalagem</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>

                    <!-- Campos para Comiss√£o ML -->
                    <div id="camposComissaoML" class="hidden">
                        <div class="form-group">
                            <label>Tipo de Comiss√£o:</label>
                            <select id="tipoComissao" onchange="alterarTipoComissao()">
                                <option value="valor">Valor Fixo por Unidade (R$)</option>
                                <option value="percentual">Percentual (%)</option>
                            </select>
                        </div>

                        <div id="comissaoValor" class="form-group">
                            <label>Valor da Comiss√£o por Unidade (R$):</label>
                            <input type="number" id="valorComissaoFixo" step="0.01" min="0" placeholder="Ex: 50.00">
                        </div>

                        <div id="comissaoPercentual" class="form-group hidden">
                            <label>Percentual da Comiss√£o (%):</label>
                            <input type="number" id="percentualComissao" step="0.01" min="0" max="100" placeholder="Ex: 15">
                            <div class="info-box">
                                ‚ÑπÔ∏è O valor ser√° calculado automaticamente em cada venda
                            </div>
                        </div>
                    </div>

                    <!-- Campo para outros tipos de despesa -->
                    <div id="campoValorDespesa" class="form-group">
                        <label>Valor da Despesa (R$):</label>
                        <input type="number" id="valorDespesa" step="0.01" min="0" placeholder="Ex: 150.00">
                    </div>

                    <div class="form-group">
                        <label>Descri√ß√£o:</label>
                        <input type="text" id="descricaoDespesa" placeholder="Ex: Troca de HD, limpeza">
                    </div>

                    <button type="submit" id="btnSalvarDespesa">üí∏ Adicionar Despesa</button>
                    <button type="button" id="btnCancelarEdicaoDespesa" class="hidden" onclick="cancelarEdicaoDespesa()" style="background: #95a5a6;">‚ùå Cancelar</button>
                </form>

                <h3 style="margin-top: 30px;">üìã Despesas Cadastradas</h3>
                <div id="listaDespesas"></div>
            </div>

            <!-- C√°lculo de Venda -->
            <div id="calculo" class="tab-content">
                <h2>üßÆ Calcular Pre√ßo de Venda</h2>
                <div id="alertaCalculo"></div>
                <form onsubmit="calcularVenda(event)">
                    <div class="form-group">
                        <label>Selecione o Lote:</label>
                        <select id="loteCalculo" required onchange="mostrarCustoAtual()"></select>
                    </div>

                    <div id="custoAtual" style="display:none;" class="resultado">
                        <h3>üìä Custos do Lote</h3>
                        <div class="resultado-item">
                            <span>Valor da Compra:</span>
                            <span id="custoCompra">R$ 0,00</span>
                        </div>
                        <div class="resultado-item">
                            <span>Total de Despesas:</span>
                            <span id="custoDespesas">R$ 0,00</span>
                        </div>
                        <div class="resultado-item resultado-destaque">
                            <span>Custo Total do Lote:</span>
                            <span id="custoTotal">R$ 0,00</span>
                        </div>
                        <div class="resultado-item">
                            <span>Quantidade de Notebooks:</span>
                            <span id="qtdNotebooks">0</span>
                        </div>
                        <div class="resultado-item resultado-destaque">
                            <span>Custo M√©dio por Unidade:</span>
                            <span id="custoMedio">R$ 0,00</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Markup Desejado (%):</label>
                        <input type="number" id="markup" required step="0.01" min="0" placeholder="Ex: 40">
                    </div>

                    <button type="submit">üî¢ Calcular</button>
                </form>

                <div id="resultadoCalculo"></div>
            </div>

            <!-- Registrar Venda -->
            <div id="vendas" class="tab-content">
                <h2>‚úÖ Registrar Venda de Notebook</h2>
                <div id="alertaVendas"></div>
                <form onsubmit="registrarVenda(event)">
                    <div class="form-group">
                        <label>Selecione o Lote:</label>
                        <select id="loteVenda" required onchange="mostrarProgressoVenda()"></select>
                    </div>

                    <div id="progressoVenda" style="display:none;">
                        <div class="resultado">
                            <h3>üìä Progresso do Lote</h3>
                            <div class="resultado-item">
                                <span>Notebooks Vendidos:</span>
                                <span id="nbVendidos">0 de 0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
                            </div>
                            <div class="resultado-item">
                                <span>Faturamento Acumulado:</span>
                                <span id="fatAcumulado">R$ 0,00</span>
                            </div>
                            <div class="resultado-item resultado-destaque">
                                <span>Meta Total do Lote:</span>
                                <span id="metaTotal">R$ 0,00</span>
                            </div>
                            <div class="resultado-item">
                                <span>Falta para Atingir Meta:</span>
                                <span id="faltaMeta" style="color: #e74c3c; font-weight: bold;">R$ 0,00</span>
                            </div>
                        </div>

                        <div class="sugestao-preco" id="sugestaoPreco">
                            <h4>üí° Sugest√£o de Pre√ßo para Pr√≥xima Venda</h4>
                            <p>Para manter o markup de <span id="markupSugerido">0</span>%:</p>
                            <div class="preco" id="precoSugerido">R$ 0,00</div>
                            <small>Este valor garante que voc√™ atinja a meta do lote</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Valor Real da Venda (R$):</label>
                        <input type="number" id="valorVendaReal" required step="0.01" min="0" placeholder="Quanto voc√™ vendeu ESTE notebook">
                    </div>

                    <div class="form-group">
                        <label>Data da Venda:</label>
                        <input type="date" id="dataVenda" required>
                    </div>

                    <div class="form-group">
                        <label>Observa√ß√µes da Venda:</label>
                        <textarea id="obsVenda" rows="3" placeholder="Detalhes da venda, parcelamento, etc."></textarea>
                    </div>

                    <button type="submit">‚úÖ Confirmar Venda</button>
                </form>
            </div>

            <!-- Hist√≥rico -->
            <div id="historico" class="tab-content">
                <h2>üìú Hist√≥rico de Vendas</h2>
                <div id="tabelaHistorico"></div>
            </div>

            <!-- Meus Lotes -->
            <div id="lotes" class="tab-content">
                <h2>üìã Todos os Lotes</h2>
                <div id="tabelaLotes"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Venda -->
    <div id="modalEditarVenda" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Editar Venda</h2>
                <span class="close" onclick="fecharModalVenda()">&times;</span>
            </div>
            <form onsubmit="salvarEdicaoVenda(event)">
                <input type="hidden" id="editVendaId">
                <div class="form-group">
                    <label>Valor da Venda (R$):</label>
                    <input type="number" id="editVendaValor" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Data da Venda:</label>
                    <input type="date" id="editVendaData" required>
                </div>
                <div class="form-group">
                    <label>Observa√ß√µes:</label>
                    <textarea id="editVendaObs" rows="3"></textarea>
                </div>
                <button type="submit">üíæ Salvar Altera√ß√µes</button>
            </form>
        </div>
    </div>

    <script>
        function carregarDados() {
            const dados = localStorage.getItem('gestaoNotebooks');
            return dados ? JSON.parse(dados) : { lotes: [], despesas: [], vendas: [] };
        }

        function salvarDados(dados) {
            localStorage.setItem('gestaoNotebooks', JSON.stringify(dados));
        }

        function openTab(event, tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));

            event.currentTarget.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'dashboard') atualizarDashboard();
            if (tabName === 'despesas') { 
                atualizarSelectDespesas(); 
                atualizarListaDespesas(); 
            }
            if (tabName === 'calculo') atualizarSelectCalculo();
            if (tabName === 'vendas') atualizarSelectVendas();
            if (tabName === 'historico') atualizarHistoricoVendas();
            if (tabName === 'lotes') atualizarTabelaLotes();
        }

        function mostrarCamposComissao() {
            const tipo = document.getElementById('tipoDespesa').value;
            const camposML = document.getElementById('camposComissaoML');
            const campoValor = document.getElementById('campoValorDespesa');

            if (tipo === 'Comiss√£o ML') {
                camposML.classList.remove('hidden');
                campoValor.classList.add('hidden');
                document.getElementById('valorDespesa').required = false;
            } else {
                camposML.classList.add('hidden');
                campoValor.classList.remove('hidden');
                document.getElementById('valorDespesa').required = true;
            }
        }

        function alterarTipoComissao() {
            const tipo = document.getElementById('tipoComissao').value;
            const campoValor = document.getElementById('comissaoValor');
            const campoPercentual = document.getElementById('comissaoPercentual');

            if (tipo === 'valor') {
                campoValor.classList.remove('hidden');
                campoPercentual.classList.add('hidden');
                document.getElementById('valorComissaoFixo').required = true;
                document.getElementById('percentualComissao').required = false;
            } else {
                campoValor.classList.add('hidden');
                campoPercentual.classList.remove('hidden');
                document.getElementById('valorComissaoFixo').required = false;
                document.getElementById('percentualComissao').required = true;
            }
        }

        function adicionarCompra(e) {
            e.preventDefault();

            const dados = carregarDados();
            const editandoId = document.getElementById('editandoLoteId').value;

            if (editandoId) {
                const lote = dados.lotes.find(l => l.id == editandoId);
                lote.nome = document.getElementById('nomeLote').value;
                lote.quantidade = parseInt(document.getElementById('quantidade').value);
                lote.valorCompra = parseFloat(document.getElementById('valorCompra').value);
                lote.observacoes = document.getElementById('observacoes').value;
                alert('‚úÖ Lote atualizado com sucesso!');
            } else {
                const novoLote = {
                    id: Date.now(),
                    nome: document.getElementById('nomeLote').value,
                    quantidade: parseInt(document.getElementById('quantidade').value),
                    quantidadeVendida: 0,
                    valorCompra: parseFloat(document.getElementById('valorCompra').value),
                    observacoes: document.getElementById('observacoes').value,
                    data: new Date().toLocaleDateString('pt-BR'),
                    status: 'Pendente',
                    markupCalculado: null,
                    valorPrevistoTotal: null
                };
                dados.lotes.push(novoLote);
                alert('‚úÖ Lote adicionado com sucesso!');
            }

            salvarDados(dados);
            e.target.reset();
            document.getElementById('editandoLoteId').value = '';
            document.getElementById('btnSalvarLote').textContent = 'üíæ Salvar Compra';
            document.getElementById('btnCancelarEdicaoLote').classList.add('hidden');
            atualizarDashboard();
        }

        function editarLote(loteId) {
            const dados = carregarDados();
            const lote = dados.lotes.find(l => l.id === loteId);

            document.getElementById('editandoLoteId').value = lote.id;
            document.getElementById('nomeLote').value = lote.nome;
            document.getElementById('quantidade').value = lote.quantidade;
            document.getElementById('valorCompra').value = lote.valorCompra;
            document.getElementById('observacoes').value = lote.observacoes || '';

            document.getElementById('btnSalvarLote').textContent = 'üíæ Atualizar Lote';
            document.getElementById('btnCancelarEdicaoLote').classList.remove('hidden');

            document.querySelectorAll('.tab')[1].click();
            window.scrollTo(0, 0);
        }

        function cancelarEdicaoLote() {
            document.getElementById('editandoLoteId').value = '';
            document.querySelector('#compra form').reset();
            document.getElementById('btnSalvarLote').textContent = 'üíæ Salvar Compra';
            document.getElementById('btnCancelarEdicaoLote').classList.add('hidden');
        }

        function adicionarDespesa(e) {
            e.preventDefault();

            const dados = carregarDados();
            const editandoId = document.getElementById('editandoDespesaId').value;
            const tipo = document.getElementById('tipoDespesa').value;
            let valor = 0;
            let isPercentual = false;
            let percentual = 0;

            if (tipo === 'Comiss√£o ML') {
                const tipoComissao = document.getElementById('tipoComissao').value;
                if (tipoComissao === 'valor') {
                    valor = parseFloat(document.getElementById('valorComissaoFixo').value);
                } else {
                    isPercentual = true;
                    percentual = parseFloat(document.getElementById('percentualComissao').value);
                    valor = 0;
                }
            } else {
                valor = parseFloat(document.getElementById('valorDespesa').value);
            }

            if (editandoId) {
                const despesa = dados.despesas.find(d => d.id == editandoId);
                despesa.loteId = parseInt(document.getElementById('loteDespesa').value);
                despesa.tipo = tipo;
                despesa.valor = valor;
                despesa.isPercentual = isPercentual;
                despesa.percentual = percentual;
                despesa.porUnidade = tipo === 'Comiss√£o ML';
                despesa.descricao = document.getElementById('descricaoDespesa').value;
                alert('‚úÖ Despesa atualizada com sucesso!');
            } else {
                const novaDespesa = {
                    id: Date.now(),
                    loteId: parseInt(document.getElementById('loteDespesa').value),
                    tipo: tipo,
                    valor: valor,
                    isPercentual: isPercentual,
                    percentual: percentual,
                    porUnidade: tipo === 'Comiss√£o ML',
                    descricao: document.getElementById('descricaoDespesa').value,
                    data: new Date().toLocaleDateString('pt-BR')
                };
                dados.despesas.push(novaDespesa);
                alert('‚úÖ Despesa adicionada com sucesso!');
            }

            salvarDados(dados);
            e.target.reset();
            document.getElementById('editandoDespesaId').value = '';
            document.getElementById('btnSalvarDespesa').textContent = 'üí∏ Adicionar Despesa';
            document.getElementById('btnCancelarEdicaoDespesa').classList.add('hidden');
            mostrarCamposComissao();
            atualizarListaDespesas();
        }

        function editarDespesa(despesaId) {
            const dados = carregarDados();
            const despesa = dados.despesas.find(d => d.id === despesaId);

            document.getElementById('editandoDespesaId').value = despesa.id;
            document.getElementById('loteDespesa').value = despesa.loteId;
            document.getElementById('tipoDespesa').value = despesa.tipo;
            document.getElementById('descricaoDespesa').value = despesa.descricao || '';

            if (despesa.tipo === 'Comiss√£o ML') {
                mostrarCamposComissao();
                if (despesa.isPercentual) {
                    document.getElementById('tipoComissao').value = 'percentual';
                    alterarTipoComissao();
                    document.getElementById('percentualComissao').value = despesa.percentual;
                } else {
                    document.getElementById('tipoComissao').value = 'valor';
                    alterarTipoComissao();
                    document.getElementById('valorComissaoFixo').value = despesa.valor;
                }
            } else {
                document.getElementById('valorDespesa').value = despesa.valor;
            }

            document.getElementById('btnSalvarDespesa').textContent = 'üíæ Atualizar Despesa';
            document.getElementById('btnCancelarEdicaoDespesa').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function cancelarEdicaoDespesa() {
            document.getElementById('editandoDespesaId').value = '';
            document.querySelector('#despesas form').reset();
            document.getElementById('btnSalvarDespesa').textContent = 'üí∏ Adicionar Despesa';
            document.getElementById('btnCancelarEdicaoDespesa').classList.add('hidden');
            mostrarCamposComissao();
        }

        function atualizarListaDespesas() {
            const dados = carregarDados();

            let html = '<table><thead><tr><th>Lote</th><th>Tipo</th><th>Valor</th><th>Descri√ß√£o</th><th>Data</th><th>A√ß√µes</th></tr></thead><tbody>';

            if (dados.despesas.length === 0) {
                html += '<tr><td colspan="6" style="text-align:center; padding: 30px;">üí∞ Nenhuma despesa cadastrada</td></tr>';
            } else {
                dados.despesas.forEach(despesa => {
                    const lote = dados.lotes.find(l => l.id === despesa.loteId);
                    const nomeLote = lote ? lote.nome : 'Lote deletado';
                    let valorDisplay = '';

                    if (despesa.isPercentual) {
                        valorDisplay = `${despesa.percentual}% (calculado na venda)`;
                    } else {
                        valorDisplay = formatarMoeda(despesa.valor);
                    }

                    html += `
                        <tr>
                            <td>${nomeLote}</td>
                            <td>${despesa.tipo}</td>
                            <td>${valorDisplay}</td>
                            <td>${despesa.descricao || '-'}</td>
                            <td>${despesa.data}</td>
                            <td>
                                <button class="btn-action btn-edit" onclick="editarDespesa(${despesa.id})">‚úèÔ∏è Editar</button>
                                <button class="btn-action btn-delete" onclick="deletarDespesa(${despesa.id})">üóëÔ∏è Excluir</button>
                            </td>
                        </tr>
                    `;
                });
            }

            html += '</tbody></table>';
            document.getElementById('listaDespesas').innerHTML = html;
        }

        function deletarDespesa(despesaId) {
            if (!confirm('Tem certeza que deseja excluir esta despesa?')) return;

            const dados = carregarDados();
            dados.despesas = dados.despesas.filter(d => d.id !== despesaId);
            salvarDados(dados);

            atualizarListaDespesas();
            atualizarDashboard();
        }

        function calcularCustoLote(loteId, valorVendaUnidade = 0) {
            const dados = carregarDados();
            const lote = dados.lotes.find(l => l.id === loteId);
            if (!lote) return null;

            const despesasLote = dados.despesas.filter(d => d.loteId === loteId);

            let totalDespesasFixas = 0;
            let totalDespesasPorVenda = 0;

            despesasLote.forEach(d => {
                if (d.porUnidade) {
                    if (d.isPercentual && valorVendaUnidade > 0) {
                        totalDespesasPorVenda += (valorVendaUnidade * d.percentual / 100);
                    } else if (!d.isPercentual) {
                        totalDespesasPorVenda += d.valor;
                    }
                } else {
                    totalDespesasFixas += d.valor;
                }
            });

            const custoTotalLote = lote.valorCompra + totalDespesasFixas;
            const custoMedioUnidade = custoTotalLote / lote.quantidade;
            const custoPorVenda = custoMedioUnidade + totalDespesasPorVenda;

            return {
                valorCompra: lote.valorCompra,
                totalDespesasFixas: totalDespesasFixas,
                custoTotalLote: custoTotalLote,
                custoMedioUnidade: custoMedioUnidade,
                despesasPorVenda: totalDespesasPorVenda,
                custoPorVenda: custoPorVenda,
                quantidade: lote.quantidade,
                quantidadeVendida: lote.quantidadeVendida
            };
        }

        function mostrarCustoAtual() {
            const loteId = parseInt(document.getElementById('loteCalculo').value);
            if (!loteId) return;

            const custos = calcularCustoLote(loteId);
            if (!custos) return;

            document.getElementById('custoAtual').style.display = 'block';
            document.getElementById('custoCompra').textContent = formatarMoeda(custos.valorCompra);
            document.getElementById('custoDespesas').textContent = formatarMoeda(custos.totalDespesasFixas);
            document.getElementById('custoTotal').textContent = formatarMoeda(custos.custoTotalLote);
            document.getElementById('qtdNotebooks').textContent = custos.quantidade;
            document.getElementById('custoMedio').textContent = formatarMoeda(custos.custoMedioUnidade);
        }

        function calcularVenda(e) {
            e.preventDefault();

            const loteId = parseInt(document.getElementById('loteCalculo').value);
            const markup = parseFloat(document.getElementById('markup').value);
            const custos = calcularCustoLote(loteId);
            if (!custos) return;

            const valorPorUnidade = custos.custoMedioUnidade * (1 + markup / 100);
            const custosComVenda = calcularCustoLote(loteId, valorPorUnidade);
            const valorPorUnidadeFinal = custosComVenda.custoPorVenda * (1 + markup / 100);
            const valorTotalLote = valorPorUnidadeFinal * custos.quantidade;
            const lucroTotal = valorTotalLote - (custosComVenda.custoPorVenda * custos.quantidade);
            const lucroPorUnidade = valorPorUnidadeFinal - custosComVenda.custoPorVenda;

            const dados = carregarDados();
            const lote = dados.lotes.find(l => l.id === loteId);
            lote.markupCalculado = markup;
            lote.valorPrevistoTotal = valorTotalLote;
            lote.valorPrevistoUnidade = valorPorUnidadeFinal;
            salvarDados(dados);

            const resultado = `
                <div class="resultado">
                    <h3>üí∞ Resultado do C√°lculo</h3>
                    <div class="resultado-item">
                        <span>Custo M√©dio por Notebook:</span>
                        <span>${formatarMoeda(custosComVenda.custoPorVenda)}</span>
                    </div>
                    <div class="resultado-item">
                        <span>Markup Aplicado:</span>
                        <span>${markup}%</span>
                    </div>
                    <div class="resultado-item resultado-destaque">
                        <span>Pre√ßo Sugerido por Notebook:</span>
                        <span>${formatarMoeda(valorPorUnidadeFinal)}</span>
                    </div>
                    <div class="resultado-item">
                        <span>Lucro por Notebook:</span>
                        <span>${formatarMoeda(lucroPorUnidade)}</span>
                    </div>
                    <div class="resultado-item resultado-destaque">
                        <span>Meta Total do Lote (${custos.quantidade} notebooks):</span>
                        <span>${formatarMoeda(valorTotalLote)}</span>
                    </div>
                    <div class="resultado-item">
                        <span>Lucro Total Previsto:</span>
                        <span>${formatarMoeda(lucroTotal)}</span>
                    </div>
                </div>
            `;

            document.getElementById('resultadoCalculo').innerHTML = resultado;
        }

        function mostrarProgressoVenda() {
            const loteId = parseInt(document.getElementById('loteVenda').value);
            if (!loteId) return;

            const dados = carregarDados();
            const lote = dados.lotes.find(l => l.id === loteId);
            const vendasLote = dados.vendas.filter(v => v.loteId === loteId);

            const vendidos = lote.quantidadeVendida;
            const total = lote.quantidade;
            const restante = total - vendidos;
            const percentual = (vendidos / total) * 100;

            const fatAcumulado = vendasLote.reduce((sum, v) => sum + v.valorReal, 0);
            const metaTotal = lote.valorPrevistoTotal || 0;
            const faltaMeta = metaTotal - fatAcumulado;

            document.getElementById('progressoVenda').style.display = 'block';
            document.getElementById('nbVendidos').textContent = `${vendidos} de ${total}`;
            document.getElementById('progressBar').style.width = `${percentual}%`;
            document.getElementById('progressBar').textContent = `${percentual.toFixed(0)}%`;
            document.getElementById('fatAcumulado').textContent = formatarMoeda(fatAcumulado);
            document.getElementById('metaTotal').textContent = formatarMoeda(metaTotal);
            document.getElementById('faltaMeta').textContent = formatarMoeda(Math.max(0, faltaMeta));

            if (restante > 0 && metaTotal > 0) {
                const precoSugerido = faltaMeta / restante;
                document.getElementById('sugestaoPreco').style.display = 'block';
                document.getElementById('markupSugerido').textContent = lote.markupCalculado || 0;
                document.getElementById('precoSugerido').textContent = formatarMoeda(Math.max(0, precoSugerido));
            } else {
                document.getElementById('sugestaoPreco').style.display = 'none';
            }
        }

        function registrarVenda(e) {
            e.preventDefault();

            const loteId = parseInt(document.getElementById('loteVenda').value);
            const valorReal = parseFloat(document.getElementById('valorVendaReal').value);
            const dataVenda = document.getElementById('dataVenda').value;
            const obs = document.getElementById('obsVenda').value;

            const dados = carregarDados();
            const lote = dados.lotes.find(l => l.id === loteId);

            const custos = calcularCustoLote(loteId, valorReal);
            const lucroEstaVenda = valorReal - custos.custoPorVenda;
            const valorPrevisto = lote.valorPrevistoUnidade || 0;
            const diferenca = valorReal - valorPrevisto;

            const novaVenda = {
                id: Date.now(),
                loteId: loteId,
                valorReal: valorReal,
                valorPrevisto: valorPrevisto,
                diferenca: diferenca,
                custoUnidade: custos.custoPorVenda,
                lucroUnidade: lucroEstaVenda,
                dataVenda: dataVenda,
                observacoes: obs
            };

            dados.vendas.push(novaVenda);
            lote.quantidadeVendida++;

            if (lote.quantidadeVendida >= lote.quantidade) {
                lote.status = 'Vendido';
            } else {
                lote.status = 'Parcial';
            }

            salvarDados(dados);

            const positivo = diferenca >= 0;
            const icone = positivo ? 'üìà' : 'üìâ';

            alert(`‚úÖ Venda registrada!

${icone} Diferen√ßa do previsto: ${formatarMoeda(diferenca)}
üí∞ Lucro nesta venda: ${formatarMoeda(lucroEstaVenda)}

üì¶ Vendidos: ${lote.quantidadeVendida} de ${lote.quantidade}`);

            e.target.reset();
            document.getElementById('dataVenda').valueAsDate = new Date();
            mostrarProgressoVenda();
            atualizarDashboard();
        }

        function abrirModalEditarVenda(vendaId) {
            const dados = carregarDados();
            const venda = dados.vendas.find(v => v.id === vendaId);

            document.getElementById('editVendaId').value = venda.id;
            document.getElementById('editVendaValor').value = venda.valorReal;
            document.getElementById('editVendaData').value = venda.dataVenda;
            document.getElementById('editVendaObs').value = venda.observacoes || '';

            document.getElementById('modalEditarVenda').style.display = 'block';
        }

        function fecharModalVenda() {
            document.getElementById('modalEditarVenda').style.display = 'none';
        }

        function salvarEdicaoVenda(e) {
            e.preventDefault();

            const dados = carregarDados();
            const vendaId = parseInt(document.getElementById('editVendaId').value);
            const venda = dados.vendas.find(v => v.id === vendaId);

            const novoValor = parseFloat(document.getElementById('editVendaValor').value);
            const custos = calcularCustoLote(venda.loteId, novoValor);

            venda.valorReal = novoValor;
            venda.dataVenda = document.getElementById('editVendaData').value;
            venda.observacoes = document.getElementById('editVendaObs').value;
            venda.custoUnidade = custos.custoPorVenda;
            venda.lucroUnidade = novoValor - custos.custoPorVenda;
            venda.diferenca = novoValor - venda.valorPrevisto;

            salvarDados(dados);
            fecharModalVenda();
            alert('‚úÖ Venda atualizada com sucesso!');
            atualizarHistoricoVendas();
            atualizarDashboard();
        }

        function deletarVenda(vendaId) {
            if (!confirm('Tem certeza que deseja excluir esta venda?')) return;

            const dados = carregarDados();
            const venda = dados.vendas.find(v => v.id === vendaId);
            const lote = dados.lotes.find(l => l.id === venda.loteId);

            lote.quantidadeVendida--;

            if (lote.quantidadeVendida === 0) {
                lote.status = 'Pendente';
            } else if (lote.quantidadeVendida < lote.quantidade) {
                lote.status = 'Parcial';
            }

            dados.vendas = dados.vendas.filter(v => v.id !== vendaId);
            salvarDados(dados);

            alert('‚úÖ Venda exclu√≠da com sucesso!');
            atualizarHistoricoVendas();
            atualizarDashboard();
        }

        function atualizarHistoricoVendas() {
            const dados = carregarDados();

            let html = '<table><thead><tr><th>Lote</th><th>Data</th><th>Valor Venda</th><th>Previsto</th><th>Diferen√ßa</th><th>Lucro</th><th>Obs</th><th>A√ß√µes</th></tr></thead><tbody>';

            if (dados.vendas.length === 0) {
                html += '<tr><td colspan="8" style="text-align:center; padding: 30px;">üìú Nenhuma venda registrada</td></tr>';
            } else {
                dados.vendas.sort((a, b) => new Date(b.dataVenda) - new Date(a.dataVenda)).forEach(venda => {
                    const lote = dados.lotes.find(l => l.id === venda.loteId);
                    const nomeLote = lote ? lote.nome : 'Lote deletado';
                    const corDif = venda.diferenca >= 0 ? '#00b894' : '#e74c3c';

                    html += `
                        <tr>
                            <td>${nomeLote}</td>
                            <td>${venda.dataVenda}</td>
                            <td>${formatarMoeda(venda.valorReal)}</td>
                            <td>${formatarMoeda(venda.valorPrevisto)}</td>
                            <td style="color: ${corDif}; font-weight: bold;">${formatarMoeda(venda.diferenca)}</td>
                            <td style="color: #00b894; font-weight: bold;">${formatarMoeda(venda.lucroUnidade)}</td>
                            <td>${venda.observacoes || '-'}</td>
                            <td>
                                <button class="btn-action btn-edit" onclick="abrirModalEditarVenda(${venda.id})">‚úèÔ∏è</button>
                                <button class="btn-action btn-delete" onclick="deletarVenda(${venda.id})">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            }

            html += '</tbody></table>';
            document.getElementById('tabelaHistorico').innerHTML = html;
        }

        function atualizarSelectDespesas() {
            const dados = carregarDados();
            const lotesAtivos = dados.lotes.filter(l => l.status !== 'Vendido');

            const selectDespesa = document.getElementById('loteDespesa');
            selectDespesa.innerHTML = '<option value="">Selecione um lote...</option>';

            if (lotesAtivos.length === 0) {
                document.getElementById('alertaDespesas').innerHTML = '<div class="alerta">‚ö†Ô∏è Voc√™ precisa cadastrar um lote primeiro</div>';
                selectDespesa.disabled = true;
            } else {
                document.getElementById('alertaDespesas').innerHTML = '';
                selectDespesa.disabled = false;
                lotesAtivos.forEach(lote => {
                    selectDespesa.innerHTML += `<option value="${lote.id}">${lote.nome}</option>`;
                });
            }
        }

        function atualizarSelectCalculo() {
            const dados = carregarDados();
            const lotesAtivos = dados.lotes.filter(l => l.status !== 'Vendido');

            const selectCalculo = document.getElementById('loteCalculo');
            selectCalculo.innerHTML = '<option value="">Selecione um lote...</option>';

            if (lotesAtivos.length === 0) {
                document.getElementById('alertaCalculo').innerHTML = '<div class="alerta">‚ö†Ô∏è Voc√™ precisa cadastrar um lote primeiro</div>';
                selectCalculo.disabled = true;
            } else {
                document.getElementById('alertaCalculo').innerHTML = '';
                selectCalculo.disabled = false;
                lotesAtivos.forEach(lote => {
                    selectCalculo.innerHTML += `<option value="${lote.id}">${lote.nome}</option>`;
                });
            }
        }

        function atualizarSelectVendas() {
            const dados = carregarDados();
            const lotesAtivos = dados.lotes.filter(l => l.status !== 'Vendido');

            const selectVenda = document.getElementById('loteVenda');
            selectVenda.innerHTML = '<option value="">Selecione um lote...</option>';

            if (lotesAtivos.length === 0) {
                document.getElementById('alertaVendas').innerHTML = '<div class="alerta">‚ö†Ô∏è Voc√™ precisa cadastrar um lote primeiro</div>';
                selectVenda.disabled = true;
            } else {
                document.getElementById('alertaVendas').innerHTML = '';
                selectVenda.disabled = false;
                lotesAtivos.forEach(lote => {
                    selectVenda.innerHTML += `<option value="${lote.id}">${lote.nome} (${lote.quantidadeVendida}/${lote.quantidade})</option>`;
                });
            }
        }

        function atualizarDashboard() {
            const dados = carregarDados();

            const totalInvestido = dados.lotes.reduce((sum, l) => sum + l.valorCompra, 0);
            let totalDespesas = dados.despesas.filter(d => !d.porUnidade).reduce((sum, d) => sum + d.valor, 0);

            const totalVendas = dados.vendas.reduce((sum, v) => sum + v.valorReal, 0);
            const lucroTotal = dados.vendas.reduce((sum, v) => sum + v.lucroUnidade, 0);

            const cards = `
                <div class="card">
                    <h3>üíº Total Investido</h3>
                    <div class="value">${formatarMoeda(totalInvestido)}</div>
                </div>
                <div class="card">
                    <h3>üí∏ Despesas Fixas</h3>
                    <div class="value">${formatarMoeda(totalDespesas)}</div>
                </div>
                <div class="card">
                    <h3>üì¶ Notebooks Vendidos</h3>
                    <div class="value">${dados.vendas.length}</div>
                </div>
                <div class="card">
                    <h3>üí∞ Faturamento</h3>
                    <div class="value">${formatarMoeda(totalVendas)}</div>
                </div>
                <div class="card">
                    <h3>üéØ Lucro Total</h3>
                    <div class="value">${formatarMoeda(lucroTotal)}</div>
                </div>
            `;

            document.getElementById('dashboardCards').innerHTML = cards;

            let tabela = '<table><thead><tr><th>Lote</th><th>Progresso</th><th>Faturado</th><th>Meta</th><th>Falta</th><th>Status</th></tr></thead><tbody>';

            if (dados.lotes.length === 0) {
                tabela += '<tr><td colspan="6" style="text-align:center; padding: 30px;">üì¶ Nenhum lote cadastrado</td></tr>';
            } else {
                dados.lotes.forEach(lote => {
                    const vendasLote = dados.vendas.filter(v => v.loteId === lote.id);
                    const faturado = vendasLote.reduce((sum, v) => sum + v.valorReal, 0);
                    const meta = lote.valorPrevistoTotal || 0;
                    const falta = Math.max(0, meta - faturado);
                    const statusClass = lote.status === 'Vendido' ? 'status-vendido' : (lote.status === 'Parcial' ? 'status-parcial' : 'status-pendente');

                    tabela += `
                        <tr>
                            <td>${lote.nome}</td>
                            <td>${lote.quantidadeVendida}/${lote.quantidade}</td>
                            <td>${formatarMoeda(faturado)}</td>
                            <td>${meta > 0 ? formatarMoeda(meta) : '-'}</td>
                            <td style="color: #e74c3c; font-weight: bold;">${meta > 0 ? formatarMoeda(falta) : '-'}</td>
                            <td><span class="status-badge ${statusClass}">${lote.status}</span></td>
                        </tr>
                    `;
                });
            }

            tabela += '</tbody></table>';
            document.getElementById('dashboardTable').innerHTML = tabela;
        }

        function atualizarTabelaLotes() {
            const dados = carregarDados();

            let html = '<table><thead><tr><th>Lote</th><th>Qtd</th><th>Vendidos</th><th>Custo</th><th>Meta</th><th>Faturado</th><th>Lucro</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>';

            if (dados.lotes.length === 0) {
                html += '<tr><td colspan="9" style="text-align:center; padding: 30px;">üì¶ Nenhum lote cadastrado</td></tr>';
            } else {
                dados.lotes.forEach(lote => {
                    const vendasLote = dados.vendas.filter(v => v.loteId === lote.id);
                    const custos = calcularCustoLote(lote.id);
                    const faturado = vendasLote.reduce((sum, v) => sum + v.valorReal, 0);
                    const lucro = vendasLote.reduce((sum, v) => sum + v.lucroUnidade, 0);
                    const statusClass = lote.status === 'Vendido' ? 'status-vendido' : (lote.status === 'Parcial' ? 'status-parcial' : 'status-pendente');

                    html += `
                        <tr>
                            <td>${lote.nome}</td>
                            <td>${lote.quantidade}</td>
                            <td>${lote.quantidadeVendida}</td>
                            <td>${custos ? formatarMoeda(custos.custoTotalLote) : '-'}</td>
                            <td>${lote.valorPrevistoTotal ? formatarMoeda(lote.valorPrevistoTotal) : '-'}</td>
                            <td>${formatarMoeda(faturado)}</td>
                            <td style="color: ${lucro >= 0 ? '#00b894' : '#e74c3c'}; font-weight: bold;">${formatarMoeda(lucro)}</td>
                            <td><span class="status-badge ${statusClass}">${lote.status}</span></td>
                            <td>
                                <button class="btn-action btn-edit" onclick="editarLote(${lote.id})">‚úèÔ∏è</button>
                                <button class="btn-action btn-delete" onclick="deletarLote(${lote.id})">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            }

            html += '</tbody></table>';
            document.getElementById('tabelaLotes').innerHTML = html;
        }

        function deletarLote(loteId) {
            if (!confirm('Tem certeza que deseja deletar este lote? Todas as vendas e despesas relacionadas tamb√©m ser√£o exclu√≠das.')) return;

            const dados = carregarDados();
            dados.lotes = dados.lotes.filter(l => l.id !== loteId);
            dados.despesas = dados.despesas.filter(d => d.loteId !== loteId);
            dados.vendas = dados.vendas.filter(v => v.loteId !== loteId);
            salvarDados(dados);

            alert('‚úÖ Lote exclu√≠do com sucesso!');
            atualizarTabelaLotes();
            atualizarDashboard();
        }

        function formatarMoeda(valor) {
            return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        window.onclick = function(event) {
            const modal = document.getElementById('modalEditarVenda');
            if (event.target == modal) {
                fecharModalVenda();
            }
        }

        window.onload = function() {
            atualizarDashboard();
            document.getElementById('dataVenda').valueAsDate = new Date();
        };
    </script>
</body>
</html>